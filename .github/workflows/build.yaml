# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: IBM Verify SDK release

on:
  # 1) Fast feedback on branch pushes (build only, no tests/scans)
  push:
    branches:
      - "main"
      - "develop"
      - "feature/**"
      - "refactor/**"
      - "fix/**"
      - "pr/**"
      - "release/**"

  # 2) Confidence gate before merge (build + tests/scans)
  pull_request:
    branches:
      - "main"
      - "release/**"
    types: [opened, synchronize, reopened, closed]

  # 3) After merge (merged PR into main) automation (create GitHub Release)
  pull_request_target:
    branches:
      - "main"
    types: [closed]

jobs:
  # ----------------------------------------------------------
  # Push-only: build (no tests)
  # ----------------------------------------------------------
  build_on_push:
    name: Build (no tests) on push
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Code checkout
        uses: actions/checkout@v4.1.1

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Load cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}

      # Keep this intentionally lightweight for fast iteration
      - name: Assemble release artifacts (no tests)
        run: ./gradlew --parallel --build-cache assembleRelease

  # ----------------------------------------------------------
  # PR: common setup (version info)
  # (runs only for pull_request events; NOT for pull_request_target)
  # ----------------------------------------------------------
  setup_environment:
    name: Setup environment
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Code checkout
        uses: actions/checkout@v4.1.1

      - name: Extract version
        id: set-vars
        run: |
          name="$(grep -o 'versionName.*' ./build.gradle.kts  | awk -F'"' '{print $3}')"
          echo "VersionName=$name" >> $GITHUB_OUTPUT
          code="$(grep -o 'versionCode.*' ./build.gradle.kts  | awk -F'"' '{print $3}')"
          echo "VersionCode=$code" >> $GITHUB_OUTPUT
          date="$(date +'%Y%m%d-%H%M%S')"
          echo "Date=$date" >> $GITHUB_OUTPUT

      - name: Set release title
        id: set-title
        run: |
          echo "ReleaseTitle=${{ steps.set-vars.outputs.VersionName }}-${{ steps.set-vars.outputs.VersionCode }}" >> $GITHUB_OUTPUT

    outputs:
      VERIFY_SDK_DATE: ${{ steps.set-vars.outputs.Date }}
      VERIFY_SDK_VERSION_CODE: ${{ steps.set-vars.outputs.VersionCode }}
      VERIFY_SDK_VERSION_NAME: ${{ steps.set-vars.outputs.VersionName }}
      VERIFY_SDK_RELEASE_TITLE: ${{ steps.set-title.outputs.ReleaseTitle }}

  # ----------------------------------------------------------
  # PR: scan (runs on PR open/update and also on merge/close)
  # ----------------------------------------------------------
  mend_scan:
    name: Mend scan
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: setup_environment
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      WS_APIKEY: ${{ secrets.WS_APIKEY }}
      WS_USERKEY: ${{ secrets.WS_USERKEY }}
      WS_PRODUCTNAME: ${{ secrets.WS_PRODUCTNAME }}
      WS_PROJECTNAME: ${{ secrets.WS_PROJECTNAME }}
      WS_WSS_URL: ${{ secrets.WS_WSS_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 1

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Download the mend scan jar
        run: |
          curl -LJO https://unified-agent.s3.amazonaws.com/wss-unified-agent.jar

      - name: Run the mend scan jar
        run: |
          java -jar ./wss-unified-agent.jar -d ${{ github.workspace }}

  # ----------------------------------------------------------
  # PR: build + tests
  # - Runs when PR is opened/updated/reopened
  # - Does NOT run on "closed" unless merged==true
  # ----------------------------------------------------------
  build_and_test:
    name: Build + unit tests (+ connected tests)
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action != 'closed' || github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    needs: mend_scan

    steps:
      - name: Code checkout
        uses: actions/checkout@v4.1.1

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Load cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}

      - name: Build and test SDKs
        run: ./gradlew --parallel --build-cache assembleRelease publishToMavenLocal dokkaJavadoc testDebugUnitTest connectedDebugAndroidTest

      - name: Store build outputs + reports
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-and-test
          path: |
            ./sdk/**/build/outputs/
            ./sdk/**/build/reports/

      - name: Store documentation
        uses: actions/upload-artifact@v4.3.1
        with:
          name: documentation
          path: |
            ./sdk/**/build/dokka/

      - name: Store maven-local artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: maven-local
          path: |
            ~/.m2/repository/com/github/ibm-verify

      - name: Publish to GitHub packages
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  coverage_report:
    name: Generate code coverage report
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action != 'closed' || github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    needs: [setup_environment, mend_scan]

    steps:
      - name: Code checkout
        uses: actions/checkout@v4.1.1

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Load cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Generate Jacoco report
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: |
            adb shell setprop log.tag.LoggerExtKtTest DEBUG
            adb shell getprop log.tag.LoggerExtKtTest
            ./gradlew --parallel --build-cache :rootCoverageReport

      - name: Store code coverage report
        uses: actions/upload-artifact@v4.3.1
        with:
          name: jacoco-report
          path: ./build/reports/

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: |
            ${{ github.workspace }}/**/build/reports/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 0
          min-coverage-changed-files: 0
          title: Code Coverage
          update-comment: true
          debug-mode: true

  # ----------------------------------------------------------
  # Create GitHub Release AFTER merge to main
  # - Triggered by pull_request_target (closed)
  # - Only runs when merged == true
  # ----------------------------------------------------------
  publish:
    name: Publish SDK, reports and documentation (on merge to main)
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout merge commit (safe)
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Load cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}

      # Rebuild from the merge commit to ensure release artifacts match what landed on main.
      - name: Build and test SDKs (release gate)
        run: ./gradlew --parallel --build-cache assembleRelease publishToMavenLocal dokkaJavadoc testDebugUnitTest connectedDebugAndroidTest

      - name: Store build outputs + reports
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-and-test
          path: |
            ./sdk/**/build/outputs/
            ./sdk/**/build/reports/

      - name: Store documentation
        uses: actions/upload-artifact@v4.3.1
        with:
          name: documentation
          path: |
            ./sdk/**/build/dokka/

      - name: Store maven-local artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: maven-local
          path: |
            ~/.m2/repository/com/github/ibm-verify

      - name: Generate coverage (merge)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: |
            ./gradlew --parallel --build-cache :rootCoverageReport

      - name: Zip code coverage report
        run: |
          mkdir -p ./sdk/jacoco
          if [ -d ./build/reports ]; then
            cp -r ./build/reports ./sdk/jacoco/
          fi
          cd ./sdk/jacoco && zip -r ../IBM-Verify-SDK_code-coverage-report.zip .

      - name: Create SDK directory
        run: mkdir -p ./sdk

      - name: Rename release files
        run: |
          # Best-effort rename; won't fail the job if a module doesn't exist
          set +e
          for m in core fido2 adaptive authentication mfa dc; do
            f="./sdk/${m}/build/outputs/aar/${m}-release.aar"
            if [ -f "$f" ]; then
              mv "$f" "./sdk/${m}/build/outputs/aar/IBM-Verify-SDK_${m}_release.aar"
            fi
          done
          set -e

      - name: Create GitHub release (draft)
        uses: softprops/action-gh-release@4634c16e79c963813287e889244c50009e7f0981
        with:
          name: "Release from main"
          tag_name: "main-${{ github.sha }}"
          draft: true
          generate_release_notes: true
          files: |
            ./sdk/**/build/outputs/aar/*.aar
            ./sdk/**/build/reports/*.html
            ./sdk/maven/*.*
            ./sdk/IBM-Verify-SDK_code-coverage-report.zip

  job_summary:
    name: Update job summary (on merge to main)
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Add markdown
        run: |
          echo '## Build Summary :white_check_mark:' >> $GITHUB_STEP_SUMMARY
          echo 'A PR was merged into **main** and the release pipeline ran.' >> $GITHUB_STEP_SUMMARY
