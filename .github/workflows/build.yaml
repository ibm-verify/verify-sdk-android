# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: IBM Verify SDK release

on:
  # PR validation: build + unit tests + connected tests + documentation
  pull_request:
    branches:
      - "main"
      - "release/**"
    types: [opened, synchronize, reopened]

  # After merge to main: build + coverage + documentation + publish release
  pull_request_target:
    branches:
      - "main"
    types: [closed]

# Default permissions are read-only; jobs elevate as needed.
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------
  # PR: build + unit tests + connected tests + docs
  # ----------------------------------------------------------
  pr_ci:
    name: PR - build, tests, connectedTests, docs
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04

    steps:
      - name: Code checkout
        uses: actions/checkout@v4.1.1

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: "17"
          distribution: "adopt"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Load Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build + unit tests + documentation
        run: |
          ./gradlew --parallel --build-cache assembleRelease testDebugUnitTest dokkaJavadoc

      # Optional but useful diagnostics for KVM availability
      - name: Ensure /dev/kvm is accessible
        run: |
          if [ -e /dev/kvm ]; then
            echo "Before:"; ls -l /dev/kvm
            sudo chmod 666 /dev/kvm
            echo "After:"; ls -l /dev/kvm
          else
            echo "/dev/kvm not present (HW acceleration may be unavailable)."
          fi

      - name: Run connected tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          target: google_apis
          profile: pixel_3a
          disable-animations: true
          emulator-options: >-
            -no-window -no-audio -no-snapshot -no-boot-anim
            -gpu swiftshader_indirect -memory 4096 -cores 2
          emulator-boot-timeout: 1200
          script: |
            set -euo pipefail

            adb kill-server || true
            adb start-server
            adb wait-for-device

            echo "Waiting for sys.boot_completed=1..."
            for i in $(seq 1 300); do
              BOOT="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)"
              if [ "$BOOT" = "1" ]; then
                break
              fi
              sleep 2
            done

            echo "Device info:"
            adb devices -l || true
            adb shell getprop ro.build.version.sdk | tr -d '\r' || true
            adb shell getprop sys.boot_completed | tr -d '\r' || true

            echo "Unlocking screen..."
            adb shell input keyevent 82 || true
            sleep 2

            echo "Running connected tests..."
            # NOTE: pass -Pci=true if you added the Gradle snippet to disable :examples connected tests in CI.
            # Also avoid --parallel here; it increases emulator flakiness on hosted runners.
            GRADLE_OPTS="-Dorg.gradle.workers.max=2" ./gradlew --build-cache connectedDebugAndroidTest -Pci=true --stacktrace

      - name: Store build outputs + reports
        uses: actions/upload-artifact@v4.3.1
        with:
          name: pr-build-and-test
          path: |
            ./sdk/**/build/outputs/
            ./sdk/**/build/reports/

      - name: Store documentation
        uses: actions/upload-artifact@v4.3.1
        with:
          name: pr-documentation
          path: |
            ./sdk/**/build/dokka/

  # ----------------------------------------------------------
  # Merge to main: build + coverage + docs + publish release
  # ----------------------------------------------------------
  publish:
    name: Merge - build, coverage, docs, publish release
    if: github.event_name == 'pull_request_target' && github.event.pull_request.merged == true
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout merge commit (safe)
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Install Java
        uses: actions/setup-java@v4.1.0
        with:
          java-version: "17"
          distribution: "adopt"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.0

      - name: Load Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build + documentation (merge)
        run: |
          ./gradlew --parallel --build-cache assembleRelease dokkaJavadoc publishToMavenLocal

      - name: Ensure /dev/kvm is accessible
        run: |
          if [ -e /dev/kvm ]; then
            echo "Before:"; ls -l /dev/kvm
            sudo chmod 666 /dev/kvm
            echo "After:"; ls -l /dev/kvm
          else
            echo "/dev/kvm not present (HW acceleration may be unavailable)."
          fi

      # Keep emulator runner here since some setups generate coverage via instrumentation.
      - name: Generate Jacoco coverage report (merge)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          profile: pixel_3a
          disable-animations: true
          emulator-options: >-
            -no-window -no-audio -no-snapshot -no-boot-anim
            -gpu swiftshader_indirect -memory 4096 -cores 2
          emulator-boot-timeout: 1200
          script: |
            set -euo pipefail

            adb kill-server || true
            adb start-server
            adb wait-for-device

            echo "Waiting for sys.boot_completed=1..."
            for i in $(seq 1 300); do
              BOOT="$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)"
              if [ "$BOOT" = "1" ]; then
                break
              fi
              sleep 2
            done

            adb shell input keyevent 82 || true
            sleep 2

            # Avoid --parallel for emulator-driven coverage; reduce contention.
            GRADLE_OPTS="-Dorg.gradle.workers.max=2" ./gradlew --build-cache :rootCoverageReport

      - name: Store documentation
        uses: actions/upload-artifact@v4.3.1
        with:
          name: documentation
          path: |
            ./sdk/**/build/dokka/

      - name: Store maven-local artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: maven-local
          path: |
            ~/.m2/repository/com/github/ibm-verify

      - name: Store build outputs + reports
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-and-reports
          path: |
            ./sdk/**/build/outputs/
            ./sdk/**/build/reports/
            ./build/reports/

      - name: Zip code coverage report
        run: |
          mkdir -p ./sdk/jacoco
          if [ -d ./build/reports ]; then
            cp -r ./build/reports ./sdk/jacoco/
          fi
          cd ./sdk/jacoco && zip -r ../IBM-Verify-SDK_code-coverage-report.zip .

      - name: Rename release files
        run: |
          set +e
          for m in core fido2 adaptive authentication mfa dc; do
            f="./sdk/${m}/build/outputs/aar/${m}-release.aar"
            if [ -f "$f" ]; then
              mv "$f" "./sdk/${m}/build/outputs/aar/IBM-Verify-SDK_${m}_release.aar"
            fi
          done
          set -e

      - name: Publish to GitHub Packages (merge)
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Maven Local
        run: ls -R ~/.m2/repository/com/github/ibm-verify/

      - name: Create GitHub release (draft)
        uses: softprops/action-gh-release@4634c16e79c963813287e889244c50009e7f0981
        with:
          name: "Release from main"
          tag_name: "main-${{ github.sha }}"
          draft: true
          generate_release_notes: true
          files: |
            ./sdk/**/build/outputs/aar/*.aar
            /home/runner/.m2/repository/com/github/ibm-verify/**/*.aar
            /home/runner/.m2/repository/com/github/ibm-verify/**/*.pom
            /home/runner/.m2/repository/com/github/ibm-verify/**/*.module
            /home/runner/.m2/repository/com/github/ibm-verify/**/*.jar
            ./sdk/IBM-Verify-SDK_code-coverage-report.zip

  job_summary:
    name: Update job summary (on merge to main)
    if: github.event_name == 'pull_request_target' && github.event.pull_request.merged == true
    runs-on: ubuntu-22.04
    needs: publish
    steps:
      - name: Add markdown
        run: |
          echo '## Build Summary :white_check_mark:' >> $GITHUB_STEP_SUMMARY
          echo 'A PR was merged into **main** and the release pipeline ran.' >> $GITHUB_STEP_SUMMARY